name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Anytype-Go ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          body: |
            # Anytype-Go ${{ github.ref_name }}
            
            A Go SDK for interacting with the [Anytype](https://anytype.io) API to manage spaces, objects, and perform searches. This library provides a feature-rich, fluent interface to integrate Anytype functionality into your Go applications.
            
            ## Features
            - Authentication management
            - Space and member management
            - Object creation, reading, updating, and deletion
            - Advanced search capabilities with filters
            - Template and type management
            - Property handling
            - Object export to different formats
            - Middleware support including retry, validation, and disconnect handling
            
            ## Installation
            
            ```bash
            go get github.com/epheo/anytype-go@${{ github.ref_name }}
            ```
            
            ## Usage
            
            ```go
            import (
                "github.com/epheo/anytype-go"
                _ "github.com/epheo/anytype-go/client" // Register client implementation
            )
            
            // Create a new client
            client, err := anytype.NewClient()
            if err != nil {
                // Handle error
            }
            
            // Work with spaces
            spaces, err := client.Space().List()
            
            // Work with objects
            obj, err := client.Object().Get("object-id")
            ```
            
            ## Documentation
            See the [README](https://github.com/epheo/anytype-go/blob/main/README.md) for comprehensive documentation including:
            
            - Quick start guide
            - Advanced examples
            - Design philosophy
            - API reference
            - Best practices
            
            API documentation is also available as a release asset attached to this release.

  publish:
    name: Publish Go Package
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Verify module is publishable
        run: |
          go mod tidy
          go mod verify
          # Wait for the Go proxy to acknowledge the new version
          echo "Verifying package availability on Go proxy..."
          sleep 60  # Give some time for the package to propagate
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "Checking for $VERSION..."
          timeout 300 bash -c 'until curl --silent --fail "https://proxy.golang.org/github.com/epheo/anytype-go/@v/$VERSION.info" > /dev/null; do echo "Waiting for package to be available..."; sleep 10; done'
          echo "Package is now available on Go proxy!"

  verify:
    name: Verify Package
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
          cache: true

      - name: Run Tests
        run: go test -v ./...

      - name: Check API Coverage
        run: |
          cd tests_api_coverage
          ./update_api_definition.sh
          go test -v

      - name: Generate SDK Documentation
        run: |
          go install github.com/swaggo/swag/cmd/swag@latest
          go install golang.org/x/tools/cmd/godoc@latest
          mkdir -p ./docs
          go doc -all github.com/epheo/anytype-go > ./docs/api.md

      - name: Upload Documentation to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.release.outputs.upload_url }}
          asset_path: ./docs/api.md
          asset_name: api-documentation.md
          asset_content_type: text/markdown
